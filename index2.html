<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>小程序测试游戏</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #4CAF50 0%, #2196F3 100%);
            font-family: Arial, sans-serif;
            overflow: hidden;
            user-select: none;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        #gameContainer {
            width: 90%;
            max-width: 500px;
            background: rgba(255,255,255,0.9);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        #gameCanvas {
            border: 3px solid #333;
            border-radius: 10px;
            background: #f0f0f0;
            display: block;
            margin: 20px auto;
            max-width: 100%;
        }

        #gameInfo {
            margin-bottom: 15px;
        }

        #score {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }

        .control-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .control-btn {
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 8px;
            width: 60px;
            height: 60px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .control-btn:hover {
            background: #45a049;
            transform: scale(1.05);
        }

        .control-btn:active {
            transform: scale(0.95);
        }

        #status {
            margin-top: 15px;
            font-size: 14px;
            color: #666;
        }

        .success {
            color: #4CAF50;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <div id="gameInfo">
            <div id="score">分数: 0</div>
            <div>点击移动按钮控制红色方块，收集蓝色圆点！</div>
        </div>
        
        <canvas id="gameCanvas" width="400" height="300"></canvas>
        
        <div class="control-buttons">
            <button class="control-btn" id="upBtn">↑</button>
        </div>
        <div class="control-buttons">
            <button class="control-btn" id="leftBtn">←</button>
            <button class="control-btn" id="downBtn">↓</button>
            <button class="control-btn" id="rightBtn">→</button>
        </div>
        
        <div id="status">游戏已准备就绪</div>
    </div>

    <script>
        // 简化的游戏类，专门为小程序web-view优化
        class MiniProgramGame {
            constructor() {
                this.canvas = document.getElementById('gameCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.score = 0;
                this.gameRunning = true;
                
                // 玩家
                this.player = {
                    x: 50,
                    y: 150,
                    size: 20,
                    color: '#e74c3c'
                };
                
                // 目标点
                this.targets = [];
                this.maxTargets = 5;
                
                this.init();
                this.setupControls();
                this.startGameLoop();
                
                // 通知父页面游戏已加载
                this.notifyParent('gameLoaded', '游戏加载完成');
            }
            
            init() {
                try {
                    this.generateTargets();
                    this.updateStatus('游戏初始化成功', 'success');
                    console.log('游戏初始化完成');
                } catch (error) {
                    console.error('游戏初始化错误:', error);
                    this.updateStatus('游戏初始化失败: ' + error.message);
                }
            }
            
            generateTargets() {
                this.targets = [];
                for (let i = 0; i < this.maxTargets; i++) {
                    this.targets.push({
                        x: Math.random() * (this.canvas.width - 30) + 15,
                        y: Math.random() * (this.canvas.height - 30) + 15,
                        size: 12,
                        collected: false
                    });
                }
            }
            
            setupControls() {
                // 按钮控制
                document.getElementById('upBtn').addEventListener('click', () => {
                    this.movePlayer(0, -25);
                });
                document.getElementById('downBtn').addEventListener('click', () => {
                    this.movePlayer(0, 25);
                });
                document.getElementById('leftBtn').addEventListener('click', () => {
                    this.movePlayer(-25, 0);
                });
                document.getElementById('rightBtn').addEventListener('click', () => {
                    this.movePlayer(25, 0);
                });
                
                // 键盘控制（如果支持）
                document.addEventListener('keydown', (e) => {
                    if (!this.gameRunning) return;
                    
                    switch(e.key) {
                        case 'ArrowUp':
                            this.movePlayer(0, -25);
                            break;
                        case 'ArrowDown':
                            this.movePlayer(0, 25);
                            break;
                        case 'ArrowLeft':
                            this.movePlayer(-25, 0);
                            break;
                        case 'ArrowRight':
                            this.movePlayer(25, 0);
                            break;
                    }
                    e.preventDefault();
                });
            }
            
            movePlayer(dx, dy) {
                if (!this.gameRunning) return;
                
                const newX = this.player.x + dx;
                const newY = this.player.y + dy;
                
                // 边界检查
                if (newX >= 0 && newX + this.player.size <= this.canvas.width &&
                    newY >= 0 && newY + this.player.size <= this.canvas.height) {
                    this.player.x = newX;
                    this.player.y = newY;
                    this.checkCollisions();
                }
            }
            
            checkCollisions() {
                this.targets.forEach(target => {
                    if (!target.collected) {
                        const distance = Math.sqrt(
                            Math.pow(this.player.x + this.player.size/2 - target.x, 2) +
                            Math.pow(this.player.y + this.player.size/2 - target.y, 2)
                        );
                        
                        if (distance < this.player.size/2 + target.size) {
                            target.collected = true;
                            this.score += 10;
                            this.updateScore();
                            this.updateStatus('收集到目标! +10分', 'success');
                        }
                    }
                });
                
                // 检查游戏结束
                if (this.targets.every(target => target.collected)) {
                    this.endGame();
                }
            }
            
            render() {
                // 清空画布
                this.ctx.fillStyle = '#f0f0f0';
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                
                // 绘制网格
                this.ctx.strokeStyle = '#ddd';
                this.ctx.lineWidth = 1;
                for (let x = 0; x < this.canvas.width; x += 40) {
                    this.ctx.beginPath();
                    this.ctx.moveTo(x, 0);
                    this.ctx.lineTo(x, this.canvas.height);
                    this.ctx.stroke();
                }
                for (let y = 0; y < this.canvas.height; y += 40) {
                    this.ctx.beginPath();
                    this.ctx.moveTo(0, y);
                    this.ctx.lineTo(this.canvas.width, y);
                    this.ctx.stroke();
                }
                
                // 绘制目标点
                this.targets.forEach(target => {
                    if (!target.collected) {
                        this.ctx.fillStyle = '#3498db';
                        this.ctx.beginPath();
                        this.ctx.arc(target.x, target.y, target.size, 0, Math.PI * 2);
                        this.ctx.fill();
                    }
                });
                
                // 绘制玩家
                this.ctx.fillStyle = this.player.color;
                this.ctx.fillRect(this.player.x, this.player.y, this.player.size, this.player.size);
                
                // 添加玩家标识
                this.ctx.fillStyle = '#fff';
                this.ctx.fillRect(this.player.x + 7, this.player.y + 7, 6, 6);
            }
            
            updateScore() {
                document.getElementById('score').textContent = `分数: ${this.score}`;
            }
            
            updateStatus(message, className = '') {
                const statusEl = document.getElementById('status');
                statusEl.textContent = message;
                statusEl.className = className;
            }
            
            endGame() {
                this.gameRunning = false;
                this.updateStatus('恭喜！游戏完成！最终分数: ' + this.score, 'success');
                this.notifyParent('gameEnd', { score: this.score });
                
                // 3秒后重新开始
                setTimeout(() => {
                    this.restart();
                }, 3000);
            }
            
            restart() {
                this.score = 0;
                this.gameRunning = true;
                this.player.x = 50;
                this.player.y = 150;
                this.generateTargets();
                this.updateScore();
                this.updateStatus('游戏重新开始！');
            }
            
            startGameLoop() {
                const gameLoop = () => {
                    try {
                        this.render();
                        if (this.gameRunning) {
                            requestAnimationFrame(gameLoop);
                        } else {
                            // 游戏结束后继续渲染
                            setTimeout(() => {
                                requestAnimationFrame(gameLoop);
                            }, 100);
                        }
                    } catch (error) {
                        console.error('游戏循环错误:', error);
                        this.updateStatus('游戏运行错误: ' + error.message);
                    }
                };
                gameLoop();
            }
            
            notifyParent(type, data) {
                try {
                    if (window.parent && window.parent !== window) {
                        window.parent.postMessage({
                            type: type,
                            data: data,
                            timestamp: Date.now()
                        }, '*');
                    }
                } catch (error) {
                    console.log('无法向父窗口发送消息:', error);
                }
            }
        }
        
        // 等待页面加载完成后启动游戏
        document.addEventListener('DOMContentLoaded', function() {
            try {
                console.log('开始初始化游戏...');
                new MiniProgramGame();
            } catch (error) {
                console.error('游戏启动失败:', error);
                document.getElementById('status').textContent = '游戏启动失败: ' + error.message;
            }
        });
        
        // 错误处理
        window.addEventListener('error', function(event) {
            console.error('全局错误:', event.error);
            document.getElementById('status').textContent = '发生错误: ' + event.error.message;
        });
    </script>
</body>
</html> 