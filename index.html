<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<meta name="viewport"
		content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no">
	<title>XGo Builder</title>
	<style>
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}

		body,
		html {
			width: 100%;
			height: 100%;
			display: flex;
			justify-content: center;
			align-items: center;
			background-color: #333;
			overflow: hidden;
		}

		canvas {
			display: block;
			margin: 0;
			outline: none;
		}



		#tabs {
			position: absolute;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
		}
	</style>
</head>

<body>
	<div id="tabs">
		<div id="tab-loader">
		</div>
		<div id="tab-editor" style="display: none;">
			<canvas id="editor-canvas" tabindex="1"></canvas>
		</div>
		<div id="tab-game" style="display: none;">
			<canvas id="game-canvas" tabindex="2"></canvas>
		</div>
	</div>

	<script>var miniEngine = null</script>
	<script>var isWasmCompressed = false</script>
	<script src="engine.js"></script>
	<script src="wasm_exec.js"></script>
	<script src="game.js"></script>
	<script>
		"use strict";
		let gameApp = null;
		let isShowEditor = false;
		let onGameErrorCallback = null;
		let urlPrefix = "https://jiepengtan.github.io/miniprogram-web-game/";
		
		// 日志转发系统
		const logQueue = [];
		const originalConsole = {
			log: console.log,
			error: console.error,
			warn: console.warn,
			info: console.info,
			debug: console.debug
		};

		// 重写console方法，拦截所有日志
		function setupLogForwarding() {
			['log', 'error', 'warn', 'info', 'debug'].forEach(method => {
				console[method] = function(...args) {
					// 调用原始的console方法
					originalConsole[method].apply(console, args);
					
					// 格式化日志信息
					const logEntry = {
						type: 'webview_log',
						level: method,
						message: args.map(arg => 
							typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
						).join(' '),
						timestamp: new Date().toISOString(),
						url: window.location.href
					};
					
					// 发送到小程序
					sendLogToMiniProgram(logEntry);
				};
			});
			
			// 拦截window错误
			window.addEventListener('error', function(event) {
				const errorLog = {
					type: 'webview_log',
					level: 'error',
					message: `JavaScript Error: ${event.message} at ${event.filename}:${event.lineno}:${event.colno}`,
					timestamp: new Date().toISOString(),
					url: window.location.href,
					stack: event.error ? event.error.stack : 'No stack trace available'
				};
				sendLogToMiniProgram(errorLog);
			});
			
			// 拦截Promise未处理的rejection
			window.addEventListener('unhandledrejection', function(event) {
				const rejectionLog = {
					type: 'webview_log',
					level: 'error',
					message: `Unhandled Promise Rejection: ${event.reason}`,
					timestamp: new Date().toISOString(),
					url: window.location.href
				};
				sendLogToMiniProgram(rejectionLog);
			});
		}

		// 发送日志到小程序
		function sendLogToMiniProgram(logEntry) {
			if (typeof wx !== 'undefined' && wx.miniProgram) {
				wx.miniProgram.postMessage({
					data: logEntry
				});
			} else {
				// 如果不在小程序环境中，暂存日志
				logQueue.push(logEntry);
			}
		}

		// 批量发送暂存的日志
		function flushLogQueue() {
			if (logQueue.length > 0 && typeof wx !== 'undefined' && wx.miniProgram) {
				logQueue.forEach(log => {
					wx.miniProgram.postMessage({
						data: log
					});
				});
				logQueue.length = 0; // 清空队列
			}
		}

		// 立即设置日志转发
		setupLogForwarding();

		function onProgress(value) {
			console.log("onProgress", value);
		}

		window.gdspx_on_runtime_panic = function (msg) {
			if (onGameErrorCallback != null) {
				onGameErrorCallback(msg);
			}
		}

		function onGameError(callback) {
			onGameErrorCallback = callback;
		}

		async function startGame() {
			await startProject(urlPrefix + 'game.zip');
		}


		async function startProject(zipUrl) {
			isShowEditor = false;
			
			// 准备游戏画布
			const canvas = document.getElementById('game-canvas');
			canvas.width = window.innerWidth;
			canvas.height = window.innerHeight;
			
			// 显示游戏画布，隐藏其他
			document.getElementById('tab-game').style.display = 'block';
			document.getElementById('tab-editor').style.display = 'none';
			document.getElementById('tab-loader').style.display = 'none';
			
			console.log("Downloading game data...");
			let buffer = await (await (fetch(zipUrl))).arrayBuffer();
			
			const config = {
				'projectName': "spx_game",
				'onProgress': onProgress,
				"gameCanvas": canvas,
				"projectData": new Uint8Array(buffer),
				"logLevel": LOG_LEVEL_NONE,
				"assetURLs": {
					"engine.zip": urlPrefix + "engine.zip",
					"game.zip": urlPrefix + "game.zip",
					"gdspx.wasm": urlPrefix + "gdspx.wasm",
					"engine.wasm": urlPrefix + "engine.wasm",
				},
				"onSpxReady": null,
			};

			if (gameApp != null) {
				await gameApp.StopGame();
			}

			console.log("Starting game...");
			// try install project and run game
			gameApp = new GameApp(config);
			await gameApp.RunGame();
			console.log("Game started successfully!");
		}

		// 解析URL参数
		function getUrlParams() {
			const urlParams = new URLSearchParams(window.location.search);
			return {
				userId: urlParams.get('userId') || 'default_user',
				gameMode: urlParams.get('gameMode') || 'normal',
				level: parseInt(urlParams.get('level')) || 1,
				timestamp: urlParams.get('timestamp')
			};
		}

		// 向小程序发送消息
		function sendMessageToMiniProgram(type, data) {
			if (typeof wx !== 'undefined' && wx.miniProgram) {
				wx.miniProgram.postMessage({
					data: { type, data }
				});
			}
		}

		// 设置错误回调
		onGameError(function (callback) {
			console.error("onGameError", callback);
			// 向小程序发送错误消息
			sendMessageToMiniProgram('gameError', { error: callback });
		});

		// 等待所有脚本加载完成后自动启动游戏
		function waitForScriptsAndStart() {
			// 检查必要的全局变量是否已定义
			if (typeof GameApp !== 'undefined' && typeof LOG_LEVEL_NONE !== 'undefined') {
				console.log("Scripts loaded, starting game...");
				
				// 获取小程序传递的参数
				const params = getUrlParams();
				console.log("接收到的参数:", params);
				
				// 向小程序发送游戏开始消息
				sendMessageToMiniProgram('gameStart', params);
				
				startGame();
			} else {
				console.log("Waiting for scripts to load...");
				setTimeout(waitForScriptsAndStart, 100);
			}
		}

		// 模拟游戏结束，发送结果给小程序
		function gameEnd(score, level) {
			const result = {
				score: score,
				level: level,
				playTime: Date.now() - (parseInt(getUrlParams().timestamp) || Date.now()),
				userId: getUrlParams().userId
			};
			console.log("游戏结束，发送结果:", result);
			sendMessageToMiniProgram('gameResult', result);
		}

		// 添加键盘事件监听，按ESC键模拟游戏结束
		document.addEventListener('keydown', function(event) {
			if (event.key === 'Escape') {
				gameEnd(Math.floor(Math.random() * 1000), getUrlParams().level);
			}
		});

		// 添加测试日志函数
		function addTestLogs() {
			console.log("🎮 游戏系统初始化完成");
			console.info("ℹ️ 正在加载游戏资源...");
			console.warn("⚠️ 这是一个警告消息示例");
			console.error("❌ 这是一个错误消息示例");
			console.debug("🔧 调试信息：系统状态正常");
			
			// 测试对象日志
			console.log("游戏配置:", {
				mode: "debug",
				version: "1.0.0",
				features: ["webview-logging", "message-passing"]
			});
		}

		// DOM加载完成后开始检查脚本
		document.addEventListener('DOMContentLoaded', function() {
			console.log("DOM loaded, waiting for scripts...");
			
			// 延迟2秒添加测试日志，方便观察日志转发效果
			setTimeout(() => {
				console.log("🚀 开始添加测试日志...");
				addTestLogs();
			}, 2000);
			
			waitForScriptsAndStart();
		});
	</script>
</body>

</html>
