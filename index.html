<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<meta name="viewport"
		content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no">
	<title>XGo Builder</title>
	<style>
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}

		body,
		html {
			width: 100%;
			height: 100%;
			display: flex;
			justify-content: center;
			align-items: center;
			background-color: #333;
			overflow: hidden;
		}

		canvas {
			display: block;
			margin: 0;
			outline: none;
		}



		#tabs {
			position: absolute;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
		}
	</style>
</head>

<body>
	<div id="tabs">
		<div id="tab-loader">
		</div>
		<div id="tab-editor" style="display: none;">
			<canvas id="editor-canvas" tabindex="1"></canvas>
		</div>
		<div id="tab-game" style="display: none;">
			<canvas id="game-canvas" tabindex="2"></canvas>
		</div>
	</div>

	<script>var miniEngine = null</script>
	<script>var isWasmCompressed = false</script>
	<script src="engine.js"></script>
	<script src="wasm_exec.js"></script>
	<script src="game.js"></script>
	<script>
		"use strict";
		let gameApp = null;
		let isShowEditor = false;
		let onGameErrorCallback = null;
		// æ£€æµ‹å½“å‰çŽ¯å¢ƒï¼Œæœ¬åœ°å¼€å‘ä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼Œçº¿ä¸Šä½¿ç”¨ç»å¯¹è·¯å¾„
		let urlPrefix = "";
		if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
			urlPrefix = ""; // æœ¬åœ°å¼€å‘ä½¿ç”¨ç›¸å¯¹è·¯å¾„
			console.log("ðŸ  æ£€æµ‹åˆ°æœ¬åœ°çŽ¯å¢ƒï¼Œä½¿ç”¨æœ¬åœ°èµ„æº");
		} else {
			urlPrefix = "https://jiepengtan.github.io/miniprogram-web-game/"; // çº¿ä¸ŠçŽ¯å¢ƒ
			console.log("ðŸŒ æ£€æµ‹åˆ°çº¿ä¸ŠçŽ¯å¢ƒï¼Œä½¿ç”¨è¿œç¨‹èµ„æº");
		}
		
		// æ—¥å¿—è½¬å‘ç³»ç»Ÿ
		const logQueue = [];
		const originalConsole = {
			log: console.log,
			error: console.error,
			warn: console.warn,
			info: console.info,
			debug: console.debug
		};

		// é‡å†™consoleæ–¹æ³•ï¼Œæ‹¦æˆªæ‰€æœ‰æ—¥å¿—
		function setupLogForwarding() {
			['log', 'error', 'warn', 'info', 'debug'].forEach(method => {
				console[method] = function(...args) {
					// è°ƒç”¨åŽŸå§‹çš„consoleæ–¹æ³•
					originalConsole[method].apply(console, args);
					
					// æ ¼å¼åŒ–æ—¥å¿—ä¿¡æ¯
					const logEntry = {
						type: 'webview_log',
						level: method,
						message: args.map(arg => 
							typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
						).join(' '),
						timestamp: new Date().toISOString(),
						url: window.location.href
					};
					
					// å‘é€åˆ°å°ç¨‹åº
					sendLogToMiniProgram(logEntry);
				};
			});
			
			// æ‹¦æˆªwindowé”™è¯¯
			window.addEventListener('error', function(event) {
				const errorLog = {
					type: 'webview_log',
					level: 'error',
					message: `JavaScript Error: ${event.message} at ${event.filename}:${event.lineno}:${event.colno}`,
					timestamp: new Date().toISOString(),
					url: window.location.href,
					stack: event.error ? event.error.stack : 'No stack trace available'
				};
				sendLogToMiniProgram(errorLog);
			});
			
			// æ‹¦æˆªPromiseæœªå¤„ç†çš„rejection
			window.addEventListener('unhandledrejection', function(event) {
				const rejectionLog = {
					type: 'webview_log',
					level: 'error',
					message: `Unhandled Promise Rejection: ${event.reason}`,
					timestamp: new Date().toISOString(),
					url: window.location.href
				};
				sendLogToMiniProgram(rejectionLog);
			});
		}

		// å‘é€æ—¥å¿—åˆ°å°ç¨‹åº
		function sendLogToMiniProgram(logEntry) {
			if (typeof wx !== 'undefined' && wx.miniProgram) {
				try {
					wx.miniProgram.postMessage({
						data: logEntry
					});
				} catch (error) {
					logQueue.push(logEntry);
				}
			} else {
				// å¦‚æžœä¸åœ¨å°ç¨‹åºçŽ¯å¢ƒä¸­ï¼Œæš‚å­˜æ—¥å¿—
				logQueue.push(logEntry);
			}
		}

		// æ‰¹é‡å‘é€æš‚å­˜çš„æ—¥å¿—
		function flushLogQueue() {
			if (logQueue.length > 0 && typeof wx !== 'undefined' && wx.miniProgram) {
				logQueue.forEach((log) => {
					try {
						wx.miniProgram.postMessage({
							data: log
						});
					} catch (error) {
						// é™é»˜å¤„ç†é”™è¯¯ï¼Œé¿å…æ— é™é€’å½’
					}
				});
				logQueue.length = 0; // æ¸…ç©ºé˜Ÿåˆ—
			}
		}

		// ç«‹å³è®¾ç½®æ—¥å¿—è½¬å‘
		setupLogForwarding();

		function onProgress(value) {
			console.log("onProgress", value);
		}

		window.gdspx_on_runtime_panic = function (msg) {
			if (onGameErrorCallback != null) {
				onGameErrorCallback(msg);
			}
		}

		function onGameError(callback) {
			onGameErrorCallback = callback;
		}

		async function startGame() {
			originalConsole.log("ðŸŽ® å¼€å§‹å¯åŠ¨æ¸¸æˆ...");
			originalConsole.log("ðŸ“ urlPrefix:", urlPrefix);
			try {
				await startProject(urlPrefix + 'game.zip');
				originalConsole.log("âœ… æ¸¸æˆå¯åŠ¨æˆåŠŸï¼");
			} catch (error) {
				originalConsole.error("âŒ æ¸¸æˆå¯åŠ¨è¿‡ç¨‹ä¸­å‡ºé”™:", error);
				originalConsole.error("Stack trace:", error.stack);
				throw error;
			}
		}


		async function startProject(zipUrl) {
			originalConsole.log("ðŸ“¦ å¼€å§‹å¯åŠ¨é¡¹ç›®:", zipUrl);
			isShowEditor = false;
			
			// å‡†å¤‡æ¸¸æˆç”»å¸ƒ
			originalConsole.log("ðŸ–¼ï¸ å‡†å¤‡æ¸¸æˆç”»å¸ƒ...");
			const canvas = document.getElementById('game-canvas');
			if (!canvas) {
				throw new Error("æ‰¾ä¸åˆ°æ¸¸æˆç”»å¸ƒå…ƒç´  'game-canvas'");
			}
			canvas.width = window.innerWidth;
			canvas.height = window.innerHeight;
			originalConsole.log("ç”»å¸ƒå°ºå¯¸:", canvas.width, "x", canvas.height);
			
			// æ˜¾ç¤ºæ¸¸æˆç”»å¸ƒï¼Œéšè—å…¶ä»–
			document.getElementById('tab-game').style.display = 'block';
			document.getElementById('tab-editor').style.display = 'none';
			document.getElementById('tab-loader').style.display = 'none';
			
			originalConsole.log("ðŸ“¥ æ­£åœ¨ä¸‹è½½æ¸¸æˆæ•°æ®:", zipUrl);
			let buffer;
			try {
				const response = await fetch(zipUrl);
				originalConsole.log("ä¸‹è½½å“åº”çŠ¶æ€:", response.status, response.statusText);
				buffer = await response.arrayBuffer();
				originalConsole.log("âœ… æ¸¸æˆæ•°æ®ä¸‹è½½å®Œæˆ, å¤§å°:", buffer.byteLength, "bytes");
			} catch (error) {
				originalConsole.error("âŒ ä¸‹è½½æ¸¸æˆæ•°æ®å¤±è´¥:", error);
				throw error;
			}
			
			const config = {
				'projectName': "spx_game",
				'onProgress': onProgress,
				"gameCanvas": canvas,
				"projectData": new Uint8Array(buffer),
				"logLevel": LOG_LEVEL_NONE,
				"assetURLs": {
					"engine.zip": urlPrefix + "engine.zip",
					"game.zip": urlPrefix + "game.zip",
					"gdspx.wasm": urlPrefix + "gdspx.wasm",
					"engine.wasm": urlPrefix + "engine.wasm",
				},
				"onSpxReady": null,
			};
			originalConsole.log("âš™ï¸ æ¸¸æˆé…ç½®:", config);

			if (gameApp != null) {
				originalConsole.log("ðŸ›‘ åœæ­¢çŽ°æœ‰æ¸¸æˆå®žä¾‹...");
				await gameApp.StopGame();
			}

			originalConsole.log("ðŸš€ åˆ›å»ºå¹¶å¯åŠ¨æ¸¸æˆå®žä¾‹...");
			try {
				// try install project and run game
				gameApp = new GameApp(config);
				originalConsole.log("âœ… GameAppå®žä¾‹åˆ›å»ºæˆåŠŸ");
				await gameApp.RunGame();
				originalConsole.log("âœ… æ¸¸æˆè¿è¡ŒæˆåŠŸï¼");
			} catch (error) {
				originalConsole.error("âŒ æ¸¸æˆå®žä¾‹åˆ›å»ºæˆ–è¿è¡Œå¤±è´¥:", error);
				originalConsole.error("Stack trace:", error.stack);
				throw error;
			}
		}

		// è§£æžURLå‚æ•°
		function getUrlParams() {
			const urlParams = new URLSearchParams(window.location.search);
			return {
				userId: urlParams.get('userId') || 'default_user',
				gameMode: urlParams.get('gameMode') || 'normal',
				level: parseInt(urlParams.get('level')) || 1,
				timestamp: urlParams.get('timestamp')
			};
		}

		// å‘å°ç¨‹åºå‘é€æ¶ˆæ¯
		function sendMessageToMiniProgram(type, data) {
			if (typeof wx !== 'undefined' && wx.miniProgram) {
				wx.miniProgram.postMessage({
					data: { type, data }
				});
			}
		}

		// è®¾ç½®é”™è¯¯å›žè°ƒ
		onGameError(function (callback) {
			originalConsole.error("onGameError", callback);
			// å‘å°ç¨‹åºå‘é€é”™è¯¯æ¶ˆæ¯
			sendMessageToMiniProgram('gameError', { error: callback });
		});

		// ç­‰å¾…æ‰€æœ‰è„šæœ¬åŠ è½½å®ŒæˆåŽè‡ªåŠ¨å¯åŠ¨æ¸¸æˆ
		function waitForScriptsAndStart() {
			// æ£€æŸ¥å¿…è¦çš„å…¨å±€å˜é‡æ˜¯å¦å·²å®šä¹‰
			originalConsole.log("ðŸ” æ£€æŸ¥è„šæœ¬åŠ è½½çŠ¶æ€:");
			originalConsole.log("  - GameApp:", typeof GameApp);
			originalConsole.log("  - LOG_LEVEL_NONE:", typeof LOG_LEVEL_NONE, LOG_LEVEL_NONE);
			originalConsole.log("  - Engine:", typeof Engine);
			originalConsole.log("  - Go:", typeof Go);
			originalConsole.log("  - GdspxFuncs:", typeof GdspxFuncs);
			
			if (typeof GameApp !== 'undefined' && typeof LOG_LEVEL_NONE !== 'undefined') {
				originalConsole.log("âœ… Scripts loaded, starting game...");
				
				// èŽ·å–å°ç¨‹åºä¼ é€’çš„å‚æ•°
				const params = getUrlParams();
				originalConsole.log("ðŸ“‹ æŽ¥æ”¶åˆ°çš„å‚æ•°:", params);
				
				// å‘å°ç¨‹åºå‘é€æ¸¸æˆå¼€å§‹æ¶ˆæ¯
				sendMessageToMiniProgram('gameStart', params);
				
				try {
					startGame();
				} catch (error) {
					originalConsole.error("âŒ æ¸¸æˆå¯åŠ¨å¤±è´¥:", error);
					originalConsole.error("Stack trace:", error.stack);
				}
			} else {
				originalConsole.log("â³ Waiting for scripts to load...");
				setTimeout(waitForScriptsAndStart, 100);
			}
		}

		// æ¨¡æ‹Ÿæ¸¸æˆç»“æŸï¼Œå‘é€ç»“æžœç»™å°ç¨‹åº
		function gameEnd(score, level) {
			const result = {
				score: score,
				level: level,
				playTime: Date.now() - (parseInt(getUrlParams().timestamp) || Date.now()),
				userId: getUrlParams().userId
			};
			originalConsole.log("æ¸¸æˆç»“æŸï¼Œå‘é€ç»“æžœ:", result);
			sendMessageToMiniProgram('gameResult', result);
		}

		// æ·»åŠ é”®ç›˜äº‹ä»¶ç›‘å¬ï¼ŒæŒ‰ESCé”®æ¨¡æ‹Ÿæ¸¸æˆç»“æŸ
		document.addEventListener('keydown', function(event) {
			if (event.key === 'Escape') {
				gameEnd(Math.floor(Math.random() * 1000), getUrlParams().level);
			}
		});

		// æ·»åŠ æµ‹è¯•æ—¥å¿—å‡½æ•°
		function addTestLogs() {
			console.log("ðŸŽ® æ¸¸æˆç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ");
			console.info("â„¹ï¸ æ­£åœ¨åŠ è½½æ¸¸æˆèµ„æº...");
			console.warn("âš ï¸ è¿™æ˜¯ä¸€ä¸ªè­¦å‘Šæ¶ˆæ¯ç¤ºä¾‹");
			console.error("âŒ è¿™æ˜¯ä¸€ä¸ªé”™è¯¯æ¶ˆæ¯ç¤ºä¾‹");
			console.debug("ðŸ”§ è°ƒè¯•ä¿¡æ¯ï¼šç³»ç»ŸçŠ¶æ€æ­£å¸¸");
			
			// æµ‹è¯•å¯¹è±¡æ—¥å¿—
			console.log("æ¸¸æˆé…ç½®:", {
				mode: "debug",
				version: "1.0.0",
				features: ["webview-logging", "message-passing"]
			});
		}

		// æ£€æŸ¥å¾®ä¿¡å°ç¨‹åºçŽ¯å¢ƒ
		function checkWxEnvironment() {
			if (typeof wx !== 'undefined' && wx.miniProgram) {
				// ç«‹å³å‘é€ä¸€æ¡æµ‹è¯•æ¶ˆæ¯
				const testMessage = {
					type: 'webview_log',
					level: 'info',
					message: 'ðŸŽ¯ Web-viewçŽ¯å¢ƒæ£€æµ‹ï¼šæ—¥å¿—è½¬å‘ç³»ç»Ÿå·²å°±ç»ª',
					timestamp: new Date().toISOString(),
					url: window.location.href
				};
				sendLogToMiniProgram(testMessage);
				
				// å°è¯•å‘é€æš‚å­˜çš„æ—¥å¿—
				setTimeout(() => {
					flushLogQueue();
				}, 500);
			}
		}

		// å®šæœŸæ£€æŸ¥å¹¶å‘é€æš‚å­˜æ—¥å¿—
		function startLogSendingInterval() {
			// æ¯éš”3ç§’å°è¯•å‘é€ä¸€æ¬¡æš‚å­˜æ—¥å¿—
			setInterval(() => {
				if (logQueue.length > 0) {
					flushLogQueue();
				}
			}, 3000);
		}

		// DOMåŠ è½½å®ŒæˆåŽå¼€å§‹æ£€æŸ¥è„šæœ¬
		document.addEventListener('DOMContentLoaded', function() {
			originalConsole.log("DOM loaded, waiting for scripts...");
			
			// ç«‹å³æ£€æŸ¥å¾®ä¿¡çŽ¯å¢ƒ
			checkWxEnvironment();
			
			// å¯åŠ¨å®šæœŸå‘é€æœºåˆ¶
			startLogSendingInterval();
			
			// å»¶è¿Ÿ1ç§’å†æ¬¡æ£€æŸ¥å¾®ä¿¡çŽ¯å¢ƒï¼ˆæœ‰æ—¶wxå¯¹è±¡éœ€è¦æ—¶é—´åŠ è½½ï¼‰
			setTimeout(() => {
				checkWxEnvironment();
			}, 1000);
			
			// å»¶è¿Ÿ2ç§’æ·»åŠ æµ‹è¯•æ—¥å¿—ï¼Œæ–¹ä¾¿è§‚å¯Ÿæ—¥å¿—è½¬å‘æ•ˆæžœ
			setTimeout(() => {
				originalConsole.log("ðŸš€ å¼€å§‹æ·»åŠ æµ‹è¯•æ—¥å¿—...");
				addTestLogs();
			}, 2000);
			
			waitForScriptsAndStart();
		});
	</script>
</body>

</html>
