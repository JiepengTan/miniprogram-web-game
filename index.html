<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<meta name="viewport"
		content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no">
	<title>XGo Builder</title>
	<style>
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}

		body,
		html {
			width: 100%;
			height: 100%;
			display: flex;
			justify-content: center;
			align-items: center;
			background-color: #333;
			overflow: hidden;
		}

		canvas {
			display: block;
			margin: 0;
			outline: none;
		}

		#controls {
			position: fixed;
			top: 10px;
			left: 10px;
			z-index: 1000;
			display: flex;
			gap: 10px;
			background: rgba(0, 0, 0, 0.7);
			padding: 10px;
			border-radius: 5px;
		}

		#controls button {
			padding: 8px 15px;
			background: #007bff;
			color: white;
			border: none;
			border-radius: 3px;
			cursor: pointer;
			font-size: 14px;
		}

		#controls button:hover {
			background: #0056b3;
		}

		#progress-bar {
			position: fixed;
			top: 60px;
			left: 10px;
			right: 10px;
			z-index: 1000;
			height: 4px;
		}

		#tabs {
			position: absolute;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
		}
	</style>
</head>

<body>
	<div id="tabs">
		<div id="tab-loader">
		</div>
		<div id="tab-editor" style="display: none;">
			<canvas id="editor-canvas" tabindex="1"></canvas>
		</div>
		<div id="tab-game" style="display: none;">
			<canvas id="game-canvas" tabindex="2"></canvas>
		</div>
	</div>

	<script>var miniEngine = null</script>
	<script>var isWasmCompressed = false</script>
	<script src="engine.js"></script>
	<script src="wasm_exec.js"></script>
	<script src="game.js"></script>
	<script>
		"use strict";
		let gameApp = null;
		let isShowEditor = false;
		let onGameErrorCallback = null;

		function onProgress(value) {
			console.log("onProgress", value);
		}

		window.gdspx_on_runtime_panic = function (msg) {
			if (onGameErrorCallback != null) {
				onGameErrorCallback(msg);
			}
		}

		function onGameError(callback) {
			onGameErrorCallback = callback;
		}

		async function startGame() {
			await startProject('https://jiepengtan.github.io/miniprogram-web-game/game.zip');
		}


		async function startProject(zipUrl) {
			isShowEditor = false;
			let buffer = await (await (fetch(zipUrl))).arrayBuffer();
			
			const config = {
				'projectName': "spx_game",
				'onProgress': onProgress,
				"gameCanvas": document.getElementById('game-canvas'),
				"projectData": new Uint8Array(buffer),
				"logLevel": LOG_LEVEL_NONE,
				"assetURLs": {
					"engine.zip": "https://jiepengtan.github.io/miniprogram-web-game/engine.zip",
					"game.zip": "https://jiepengtan.github.io/miniprogram-web-game/game.zip",
					"gdspx.wasm": "https://jiepengtan.github.io/miniprogram-web-game/gdspx.wasm",
					"engine.wasm": "https://jiepengtan.github.io/miniprogram-web-game/engine.wasm",
				},
				"onSpxReady": null,
			};

			if (gameApp != null) {
				await gameApp.StopGame();
			}

			// try install project and run game
			gameApp = new GameApp(config);
			await gameApp.RunGame();
		}

		// 添加事件监听器
		document.getElementById('startNewGameBtn').addEventListener('click', startNewGame);
		document.getElementById('startGameBtn').addEventListener('click', startGame);
		document.getElementById('stopGameBtn').addEventListener('click', stopGame);

		// 设置错误回调
		onGameError(function (callback) {
			console.error("onGameError", callback);
		});

		// 页面加载完成后自动启动游戏
		window.addEventListener('load', function() {
			console.log("window.addEventListener load");
			// 延迟一点时间确保所有脚本都已加载
			setTimeout(startGame, 1000);
		});
	</script>
</body>

</html>
